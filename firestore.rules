rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    
    // Check if user is an Admin
    // Includes a hardcoded check for the super admin email to securely bootstrap permissions
    function isAdmin() {
      return (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
             (request.auth.token.email == 'easeyspace@yahoo.com');
    }

    // Check if user has a specific permission
    // Grants access if user is Admin OR has the permission string in their 'permissions' array
    function hasPermission(permission) {
      return isAdmin() || (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        permission in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions
      );
    }
    
    // --- COLLECTION RULES ---

    // 1. Users Collection
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Strict creation: Users can only create their own doc with role='user' and no permissions.
      // Exception: The super admin (via email check) can create with any role.
      allow create: if request.auth != null && request.auth.uid == userId && (
        isAdmin() || 
        (
          (request.resource.data.role == 'user' || !('role' in request.resource.data)) &&
          (request.resource.data.permissions == [] || !('permissions' in request.resource.data))
        )
      );

      // Allow update if Admin OR (Self AND not changing role/permissions)
      allow update: if request.auth != null && (
        isAdmin() || 
        (request.auth.uid == userId && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'permissions']))
      );
      allow delete: if isAdmin(); 

      match /{document=**} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // 2. Wallet & Finance
    match /wallet_transactions/{document=**} {
      allow read: if hasPermission('access_wallet');
      allow write: if hasPermission('manage_wallet');
    }
    
    match /wallet_stats/{document=**} {
      allow read: if hasPermission('access_wallet');
      allow write: if hasPermission('manage_wallet');
    }

    // 3. Orders & Checkouts (Database)
    match /orders/{document=**} {
      allow read: if hasPermission('access_orders');
      allow create: if hasPermission('manage_orders');
      allow delete: if hasPermission('manage_orders'); 
      allow update: if hasPermission('manage_orders') && (
        isAdmin() || 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['adminEdited', 'adminModifiedFields'])
      );
    }
    
    match /checkouts/{document=**} {
      allow read: if hasPermission('access_orders');
      // write is generally server-side, but if we need manual edits:
      allow write: if isAdmin();
    }

    // 4. WhatsApp
    match /whatsapp_messages/{document=**} {
      allow read: if hasPermission('access_whatsapp');
      allow create: if hasPermission('access_whatsapp'); // Sending messages
      allow update, delete: if isAdmin();
    }

    // 5. Campaigns
    match /campaigns/{document=**} {
      allow read: if hasPermission('access_campaigns');
      allow write: if hasPermission('manage_campaigns');
    }
    
    // 6. Notes (Personal + Shared if implemented)
    match /notes/{noteId} {
      allow read: if request.auth != null && (isAdmin() || resource.data.userId == request.auth.uid);
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && (isAdmin() || resource.data.userId == request.auth.uid);
    }
    
    // 7. Push Tokens (System)
    // Locked down: Users can only manage their own tokens.
    match /push_tokens/{token} {
      allow read: if request.auth != null && (isAdmin() || resource.data.userId == request.auth.uid);
      allow create, update: if request.auth != null && (isAdmin() || request.resource.data.userId == request.auth.uid);
      allow delete: if request.auth != null && (isAdmin() || resource.data.userId == request.auth.uid);
    }

    // Fallback: Default Deny for everything else
    match /{document=**} {
      allow read, write: if false; 
    }
  }
}
